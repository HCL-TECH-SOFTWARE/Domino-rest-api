# Richtext extension

Richtext extension is for customers or users that prefer to have or use their own implementation of richtext processor. Users will be able to adjust it to meet their own needs, resulting in a better representation of their richtext.

## Extend Domino REST API richtext

Starting Domino REST API version `1.0.12`, you can now add richtext processors for Domino REST API.

## Set up extending richtext

There are a number of things you should setup before you can create an extension.

### Install KEEP core jar

1. Install Domino REST API using the Domino REST API installer.
2. Find the `keep-core-<version>.jar`in the **Domino REST API install directory** and do a **Maven** install using the following command:

  ```shell
  mvn org.apache.maven.plugins:maven-install-plugin:2.5.2:install-file -Dfile=<path-to-keep-core-jar>
  ```

This adds **KEEP Core** to your local Maven M2 repository.

### Create an extension helper

The goal is to create an extension helper that generates a single JAR file containing all the dependencies needed in extending richtext.

Extending richtext needs the following dependencies:

- KEEP core
- Vert.X core
- Domino JNX API

**To create an extension helper**:

1. Create a new folder. Any folder name will do and can be placed in any directory.
2. Create a `pom.xml` file in the created folder. The file should have the following content:

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <project xmlns="http://maven.apache.org/POM/4.0.0"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

      <modelVersion>4.0.0</modelVersion>

      <groupId>com.hcl.domino.extension.helper</groupId>
      <artifactId>keep-richtext-extension-helper</artifactId>
      <version>1.0</version>
      <name>Helper for KEEP richtext extension</name>
      <description>Don't try this at home</description>

      <dependencies>
        <dependency>
          <groupId>com.hcl.domino.keep</groupId>
          <artifactId>keep-core</artifactId>
          <version>1.0.12</version>
        </dependency>
        <dependency>
          <groupId>io.vertx</groupId>
          <artifactId>vertx-core</artifactId>
          <version>4.5.7</version>
        </dependency>
        <dependency>
          <groupId>com.hcl.domino</groupId>
          <artifactId>domino-jnx-api</artifactId>
          <version>1.41.0</version>
        </dependency>
      </dependencies>

    </project>
    ```

3. Save the `pom.xml` and execute the following command:

    ```shell
    mvn clean install
    ```

    Executing the command generates a `keep-richtext-extension-helper-1.0.jar` file in the target directory. It will include this JAR file in your local Maven M2 repository, allowing you to use it as a dependency for your richtext extension project.

## Extend richtext

### Set up richtext extension project

1. Create a new project for the richtext extension by creating a new Maven project using the following command:

    ```shell
    mvn archetype:generate -DgroupId=com.example -DartifactId=richtext-extension -DarchetypeArtifactId=maven-archetype-quickstart -DarchetypeVersion=1.4 -DinteractiveMode=false
    ```

    The command generates a directory called `richtext-extension`, including a `src` folder and a `pom.xml` file.

2. Open the `pom.xml` file and change the settings of `maven.compiler.source` and `maven.compiler.target` to `1.8`.
3. Under the dependencies section, include the JAR file that was generated by your extension helper earlier:

    ```xml
    <dependency>
      <groupId>com.hcl.domino.extension.helper</groupId>
      <artifactId>keep-richtext-extension-helper</artifactId>
      <version>1.0</version>
      <scope>provided</scope>
    </dependency>
    ```

4. Save the `pom.xml` after adding the dependency.

!!!note
    The **`scope`** is set to **`provided`** because you don't want the dependency be compiled together with your richtext extension as you will be putting the extension JAR alongside the KEEP JARs. The KEEP JARs will contain all the dependencies that your extension JAR will need.

### Creating your own richtext processors

We have 2 different interfaces that we can implement to create our very own richtext processor, `IncomingRichtextProcessor` and `OutgoingRichtextProcessor`.

#### Incoming richtext processor

This processes how the incoming richtext JSON is saved in the richtext field. This processor makes use of the `type` property in richtext JSON to determine what incoming richtext processor to use.

##### Built-in incoming richtext processors

There are four built-in incoming richtext processors:

1. `multipart/mixed` - used by default if `type` in richtext JSON doesn't equate to any existing richtext processors.
2. `text/plain`
3. `text/markdown`
4. `text/html`

##### Creating your own incoming richtext processor

1. Create a class that implements `IncomingRichtextProcessor`.

    Currently, `IncomingRichtextProcessor` has three methods. Two of which has default implementations.

    `getProcessorName` is an abstract method that should return a `String` that represents the name of this incoming richtext processor. It checks this against the `type` property of a richtext JSON to determine if this incoming processor should be used.

    `process` is a method that has a default implementation. By default, it checks if the incoming `content` of the richtext JSON looks like a mime, it directly returns it as a `Buffer`, if not, it manually constructs a mime using the richtext JSON properties, and return the constructed mime as a `Buffer`. You are also free to override this method and control how you want to save the incoming richtext.

    `getPriority` is a default method that returns `0`. You can leave this method be, unless you have an incoming richtext processor that has the same return value of `getProcessorName` with other existing incoming richtext processors. The higher the number, the higher the priority.

    An example incoming richtext processor would be:

    ```java
    package com.example;

    import java.util.Optional;
    import java.util.Set;

    import com.hcl.domino.keep.info.richtext.CreateAdditional;
    import com.hcl.domino.keep.info.richtext.RichtextMimeHelper;
    import com.hcl.domino.keep.info.richtext.spi.IncomingRichtextProcessor;

    import io.vertx.core.buffer.Buffer;
    import io.vertx.core.json.JsonObject;

    /**
     * Always saves "hi" as a text/plain mime regardless of what's inside the richtext JSON
     */
    public class AlwaysHiIncomingRichtextProcessor implements IncomingRichtextProcessor {

      @Override
      public String getProcessorName() {
        return "alwayshi";
      }

      @Override
      public Optional<Buffer> process(JsonObject richJson, byte[] contentBytes,
          final Set<CreateAdditional> createAdditional) {
        final Optional<String> mime = RichtextMimeHelper.plain2mime("Hi!".getBytes());

        if (!mime.isPresent()) {
          return Optional.empty();
        }
        return Optional.of(Buffer.buffer(mime.get()));
      }

    }
    ```

2. Create a file within the `src/main/resources/META-INF/services` directory and name the file `com.hcl.domino.keep.info.richtext.spi.IncomingRichtextProcessor`.

3. Edit the file `com.hcl.domino.keep.info.richtext.spi.IncomingRichtextProcessor` and include all the richtext extensions you created, such as:

    ```text
    com.example.AlwaysHiIncomingRichtextProcessor
    ```

!!!warning "Important"
    All classes declared in this file must exist and implement the `IncomingRichtextProcessor` class. Otherwise, an error will be triggered when attempting to load this using Domino REST API.

#### Outgoing richtext processor

This processes how the saved data in a richtext field is shown when returned as a response to a GET request. This processor bases on the value `richTextAs` query parameter to know which outgoing richtext processor to use.

##### Built-in outgoing richtext processors

There are four built-in outgoing richtext processors:

1. `mime`
2. `plain`
3. `markdown`
4. `html`

##### Creating your own outgoing richtext processor

1. Create a class that implements `OutgoingRichtextProcessor`.

    Currently, `OutgoingRichtextProcessor` has three methods. One of which has default implementations.

    `getProcessorName` is an abstract method that should return a `String` that represents the name of this incoming richtext processor. It checks this against the `richTextAs` query parameter of the GET request to know which outgoing richtext processor to use.

    `process` is an abstract method that can be overwritten to specify how to represent the richtext content in the response.

    `getPriority` is a default method that returns `0`. You can leave this method be, unless you have an outgoing richtext processor that has the same return value of `getProcessorName` with other existing outgoing richtext processors. The higher the number, the higher the priority.

    An example outgoing richtext processor would be:

    ```java
    package com.example;

    import com.hcl.domino.DominoClient;
    import com.hcl.domino.data.Document;
    import com.hcl.domino.keep.info.richtext.spi.OutgoingRichtextProcessor;

    import io.vertx.core.json.JsonObject;

    /**
     * Always returns "hello" in the response.
     */
    public class AlwaysHelloRichtextProcessor implements OutgoingRichtextProcessor {

      @Override
      public String getProcessorName() {
        return "alwayshello";
      }

      @Override
      public JsonObject process(DominoClient client, Document doc, String itemName) {
        return new JsonObject()
            .put("type", "text/plain")
            .put("encoding", "plain")
            .put("content", "Hello!");
      }

    }
    ```

2. Create a file within the `src/main/resources/META-INF/services` directory and name the file `com.hcl.domino.keep.info.richtext.spi.OutgoingRichtextProcessor`.

3. Edit the file `com.hcl.domino.keep.info.richtext.spi.OutgoingRichtextProcessor` and include all the richtext extensions you created, such as:

    ```text
    com.example.AlwaysHelloRichtextProcessor
    ```

!!!warning "Important"
    All classes declared in this file must exist and implement the `OutgoingRichtextProcessor` class. Otherwise, an error will be triggered when attempting to load this using Domino REST API.

### Apply the richtext extension

Once you have finished creating your richtext extensions, it's time to use it. Create the JAR file for the richtext extension by running the following command:

  ```shell
  mvn clean package
  ```

This creates a JAR file inside the target directory with the name `richtext-extension-1.0-SNAPSHOT.jar`. Copy this JAR file and paste it into where your KEEP JARs are at (Domino REST API directory).

### Try it out

#### Try the incoming richtext processor

First, we need to create a form, and it has to have a richtext field in it. An example response body would be:

```json
{
  ...
  "Form": "SampleForm",
  "rtField": {
    "type": "alwayshi",
    "encoding": "plain",
    "content": "my content"
  },
  ...
}
```

Notice that the `type` in the richtext JSON is set to the name of our own incoming richtext processor `alwayshi`.

Before executing the request, you should set the value of `richTextAs` query parameter to `plain` so we can verify the value of the richtext field in plain text.

After executing the request, you should get the following JSON for the richtext field:

```json
{
  "type": "text/plain",
  "encoding": "plain",
  "content": "Hi!"
}
```

#### Try the outgoing richtext processor

To try it out, you can call any API that has a `richTextAs` query parameter, and set its value to your processor name.

For example, if you use the `AlwaysHelloRichtextProcessor`, since its `getProcessorName` method returns `alwayshello`, if you do an API and set `richTextAs=alwayshello`, you should get the following JSON value for the richtext fields:

```json
{
  "type": "text/plain",
  "encoding": "plain",
  "content": "Hello!"
}
```
